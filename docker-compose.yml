services:
  namenode:
    image: apache/hadoop:3.3.6
    container_name: namenode
    hostname: namenode
    ports:
      - "9870:9870"
      - "9820:9820"
    environment:
      - CLUSTER_NAME=test_cluster
    volumes:
      - hdfs_namenode:/hadoop/dfs/name
      - ./hadoop-config:/opt/hadoop/etc/hadoop
    command: >
      sh -c "
        chown -R hadoop:hadoop /hadoop/dfs/name &&
        chmod -R 755 /hadoop/dfs/name &&
        hdfs namenode -format -force &&
        hdfs --daemon start namenode &&
        tail -f /dev/null
      "
    user: "root"

  datanode:
    image: apache/hadoop:3.3.6
    container_name: datanode
    hostname: datanode
    ports:
      - "9864:9864"
    depends_on:
      - namenode
    environment:
      - CLUSTER_NAME=test_cluster
    volumes:
      - hdfs_datanode:/hadoop/dfs/data
      - ./hadoop-config:/opt/hadoop/etc/hadoop
    command: >
      sh -c "
        chown -R hadoop:hadoop /hadoop/dfs/data &&
        chmod -R 755 /hadoop/dfs/data &&
        hdfs --daemon start datanode &&
        tail -f /dev/null
      "
    user: "root"

  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

  mongodb:
    image: mongo:6.0
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongo-express:
    image: mongo-express
    container_name: mongo-express
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: password123
    depends_on:
      mongodb:
        condition: service_healthy

volumes:
  hdfs_namenode:
  hdfs_datanode:
  minio_data:
  mongo_data:
